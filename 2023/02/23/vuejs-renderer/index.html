<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Kcfuler Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://dogefs.s3.ladydaily.com/~/source/unsplash/photo-1676840642714-2ebccd286ca2?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2070&amp;q=80">
    <meta property="twitter:image" content="https://dogefs.s3.ladydaily.com/~/source/unsplash/photo-1676840642714-2ebccd286ca2?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2070&amp;q=80" />
    

    
    <meta name="title" content="Vue的渲染器" />
    <meta property="og:title" content="Vue的渲染器" />
    <meta property="twitter:title" content="Vue的渲染器" />
    

    
    <meta name="description" content="vue渲染器实现方案">
    <meta property="og:description" content="vue渲染器实现方案" />
    <meta property="twitter:description" content="vue渲染器实现方案" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="柯昌鹏, KeChangePeng, keChangePeng, , 柯昌鹏的网络日志, 柯昌鹏的博客, KeChangePeng Blog, 博客, 个人网站, 互联网, Web">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Vue的渲染器 | 柯昌鹏的博客 | kcfuler Blog</title>

    <link rel="canonical" href="/2023/02/23/vuejs-renderer/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>






<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kcfuler Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/life">life</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/about/">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('https://dogefs.s3.ladydaily.com/~/source/unsplash/photo-1676840642714-2ebccd286ca2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2070&q=80')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                    </div>
                    <h1>Vue的渲染器</h1>
                    <h2 class="subheading">Vue.js设计与实现读书笔记</h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                kcfuler
                             
                            on 
                            Friday, February 24, 2023
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="渲染器设计">渲染器设计</h2>
<h3 id="渲染器与响应式系统">渲染器与响应式系统</h3>
<ul>
<li>
<p>响应式系统为渲染器提供数据， 也就是当数据发生变化时，为渲染器提供新的数据供其渲染。</p>
</li>
<li>
<p>渲染器将响应式系统的数据渲染到页面上。</p>
</li>
</ul>
<h3 id="相关名词">相关名词</h3>
<ol>
<li>renderer</li>
</ol>
<p>渲染器，这里的渲染器概念是比较大的，不仅包含渲染的内容，在SSR的场景中可能还包含着水合等功能</p>
<ol start="2">
<li>render</li>
</ol>
<p>渲染函数，将数据渲染为特定平台的页面内容。</p>
<ol start="3">
<li>Virtual DOM || vdom</li>
</ol>
<p>也就是虚拟DOM，在vue中用于处理节点的更新</p>
<ol start="4">
<li>patch</li>
</ol>
<p>页面更新操作，对比新旧DOM，只更新需要更新的内容</p>
<h3 id="自定义渲染器的实现">自定义渲染器的实现</h3>
<p>实现重点：平台无关</p>
<p>通过传入配置项的方式来传入和平台相关的配置项内容，实现平台相关的渲染api和渲染器解耦，也就实现了平台无关的渲染能力。</p>
<h2 id="挂载与更新">挂载与更新</h2>
<h3 id="html-attributes-和-dom-properties">HTML Attributes 和 DOM Properties</h3>
<p>Html Attributes 就是指直接挂载在HTML标签上的内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-HTML" data-lang="HTML"><span style="display:flex;"><span>&lt;<span style="color:#ff79c6">a</span> <span style="color:#50fa7b">attributes</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;something&#39;</span>&gt; this is content&lt;/<span style="color:#ff79c6">a</span>&gt;
</span></span></code></pre></div><p>DOM Properties则是指挂载到dom上之后，元素上拥有的各种属性。</p>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=NTc0M2NmNTRiNmQ1YWEwODhmOTFlYTQ0MTA5Zjk2NGFfYXZOTDR0TWZEdXBocHZQZlFsdTdOZTZVQno4alR0NE1fVG9rZW46Ym94Y252VUVKWTNWVlpaeDRtU3RzcXJJMkloXzE2NzcyNDU0MDA6MTY3NzI0OTAwMF9WNA" alt="">

</p>
<p>**HTML Attributes 的作用是设置与之对应的 DOM Properties 的初始值。**一旦值改变，那么 DOM Properties 始终存储着当前值，而通过 getAttribute 函数得到的仍然是初始值。</p>
<p>一个 HTML Attributes 可能对应着多个 DOM Property。<code>value=&quot;foo&quot; 与 el.value 和 el.defaultValue</code> 都有关联</p>
<h3 id="组件的卸载">组件的卸载</h3>
<p>不能直接使用 <code>innerHTML = &quot;&quot;</code> 的方式来卸载组件</p>
<ul>
<li>
<p>容器的内容可能是由某个或多个组件渲染的，当卸载操作发生时，应该正确地调用这些组件的 beforeUnmount、unmounted 等生命周期函数。</p>
</li>
<li>
<p>即使内容不是由组件渲染的，有的元素存在自定义指令，我们应该在卸载操作发生时正确执行对应的指令钩子函数。</p>
</li>
<li>
<p>使用 innerHTML 清空容器元素内容的另一个缺陷是，它不会移除绑定在 DOM 元素上的事件处理函数。</p>
</li>
</ul>
<p>正确的处理方法是使用原生的DOM方法来执行卸载操作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> mountElement(vnode, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#6272a4">// 让 vnode.el 引用真实 DOM 元素
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">03</span>   <span style="color:#ff79c6">const</span> el <span style="color:#ff79c6">=</span> vnode.el <span style="color:#ff79c6">=</span> createElement(vnode.type)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> vnode.children <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     setElementText(el, vnode.children)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(vnode.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>     vnode.children.forEach(child =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>       patch(<span style="color:#ff79c6">null</span>, child, el)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>     })
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>   <span style="color:#ff79c6">if</span> (vnode.props) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>     <span style="color:#ff79c6">for</span> (<span style="color:#ff79c6">const</span> key <span style="color:#ff79c6">in</span> vnode.props) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>       patchProps(el, key, <span style="color:#ff79c6">null</span>, vnode.props[key])
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>   insert(el, container)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span> }
</span></span></code></pre></div><p>当我们调用 createElement 函数创建真实 DOM 元素时，会把真实DOM 元素赋值给 vnode.el 属性。这样，在vnode 与真实 DOM 元素之间就建立了联系，我们可以通过 vnode.el 来获取该虚拟节点对应的真实 DOM 元素。有了这些，当卸载操作发生的时候，只需要根据虚拟节点对象 vnode.el 取得真实DOM 元素，再将其从父元素中移除即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#6272a4">// 封装 unmounted函数，可以在这里面调用 onUnmounted 钩子对应的逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> unmount(vnode) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">const</span> parent <span style="color:#ff79c6">=</span> vnode.el.parentNode
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>   <span style="color:#ff79c6">if</span> (parent) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>     parent.removeChild(vnode.el)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span> }
</span></span></code></pre></div><p>当 unmount 函数执行时，我们有机会检测虚拟节点 vnode 的类型。如果该虚拟节点描述的是组件，则我们有机会调用组件相关的生命周期函数。</p>
<h3 id="区分vnode的类型">区分vnode的类型</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> patch(n1, n2, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (n1 <span style="color:#ff79c6">&amp;&amp;</span> n1.type <span style="color:#ff79c6">!==</span> n2.type) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     unmount(n1)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>     n1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>   <span style="color:#6272a4">// 代码运行到这里，证明 n1 和 n2 所描述的内容相同
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">07</span>   <span style="color:#ff79c6">const</span> { type } <span style="color:#ff79c6">=</span> n2
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>   <span style="color:#6272a4">// 如果 n2.type 的值是字符串类型，则它描述的是普通标签元素
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">09</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> type <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>     <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>n1) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>       mountElement(n2, container)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>     } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>       patchElement(n1, n2)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> type <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;object&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>     <span style="color:#6272a4">// 如果 n2.type 的值的类型是对象，则它描述的是组件
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">17</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (type <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;xxx&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>     <span style="color:#6272a4">// 处理其他类型的 vnode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">19</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span> }
</span></span></code></pre></div><h3 id="事件的处理">事件的处理</h3>
<p>我们可以绑定一个伪造的事件处理函数 invoker，然后把真正的事件处理函数设置为 invoker.value 属性的值。这样当更新事件的时候，我们将不再需要调用 removeEventListener 函数来移除上一次绑定的事件，只需要更新invoker.value 的值即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> patchProps(el, key, prevValue, nextValue) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#f1fa8c">/^on/</span>.test(key)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#6272a4">// 获取为该元素伪造的事件处理函数 invoker
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">04</span>     <span style="color:#8be9fd;font-style:italic">let</span> invoker <span style="color:#ff79c6">=</span> el._vei
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#ff79c6">const</span> name <span style="color:#ff79c6">=</span> key.slice(<span style="color:#bd93f9">2</span>).toLowerCase()
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#ff79c6">if</span> (nextValue) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>       <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>invoker) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>         <span style="color:#6272a4">// 如果没有 invoker，则将一个伪造的 invoker 缓存到 el._vei 中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">09</span>         <span style="color:#6272a4">// vei 是 vue event invoker 的首字母缩写
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>         invoker <span style="color:#ff79c6">=</span> el._vei <span style="color:#ff79c6">=</span> (e) =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>           <span style="color:#6272a4">// 当伪造的事件处理函数执行时，会执行真正的事件处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">12</span>           invoker.value(e)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>         <span style="color:#6272a4">// 将真正的事件处理函数赋值给 invoker.value
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">15</span>         invoker.value <span style="color:#ff79c6">=</span> nextValue
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>         <span style="color:#6272a4">// 绑定 invoker 作为事件处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">17</span>         el.addEventListener(name, invoker)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>       } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>         <span style="color:#6272a4">// 如果 invoker 存在，意味着更新，并且只需要更新 invoker.value 的值即可
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">20</span>         invoker.value <span style="color:#ff79c6">=</span> nextValue
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>     } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (invoker) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>       <span style="color:#6272a4">// 新的事件绑定函数不存在，且之前绑定的 invoker 存在，则移除绑定
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">24</span>       el.removeEventListener(name, invoker)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (key <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;class&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">27</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">28</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (shouldSetAsProps(el, key, nextValue)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">30</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">31</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">32</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">33</span> }
</span></span></code></pre></div><ul>
<li>
<p>先从 el._vei 中读取对应的 invoker，如果 invoker 不存在，则将伪造的 invoker 作为事件处理函数，并将它缓存到 el._vei 属性中。</p>
</li>
<li>
<p>把真正的事件处理函数赋值给 invoker.value 属性，然后把伪造的 invoker 函数作为事件处理函数绑定到元素上。可以看到，当事件触发时，实际上执行的是伪造的事件处理函数，在其内部间接执行了真正的事件处理函数 invoker.value(e)。</p>
</li>
</ul>
<h4 id="处理多个事件同一事件对应多个响应">处理多个事件、同一事件对应多个响应</h4>
<p>vnode.props</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">const</span> vnode <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;p&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>   props<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>     onClick<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>       <span style="color:#6272a4">// 第一个事件处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">06</span>       () =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>         alert(<span style="color:#f1fa8c">&#39;clicked 1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>       },
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>       <span style="color:#6272a4">// 第二个事件处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>       () =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>         alert(<span style="color:#f1fa8c">&#39;clicked 2&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>     ]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>   },
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>   children<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;text&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span> }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span> renderer.render(vnode, <span style="color:#8be9fd;font-style:italic">document</span>.querySelector(<span style="color:#f1fa8c">&#39;#app&#39;</span>))
</span></span></code></pre></div><p>patchProps</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> patchProps(el, key, prevValue, nextValue) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#f1fa8c">/^on/</span>.test(key)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#ff79c6">const</span> invokers <span style="color:#ff79c6">=</span> el._vei <span style="color:#ff79c6">||</span> (el._vei <span style="color:#ff79c6">=</span> {})
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>     <span style="color:#8be9fd;font-style:italic">let</span> invoker <span style="color:#ff79c6">=</span> invokers[key]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#ff79c6">const</span> name <span style="color:#ff79c6">=</span> key.slice(<span style="color:#bd93f9">2</span>).toLowerCase()
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#ff79c6">if</span> (nextValue) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>       <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>invoker) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>         invoker <span style="color:#ff79c6">=</span> el._vei[key] <span style="color:#ff79c6">=</span> (e) =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>           <span style="color:#6272a4">// 如果 invoker.value 是数组，则遍历它并逐个调用事件处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>           <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(invoker.value)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>             invoker.value.forEach(fn =&gt; fn(e))
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>           } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>             <span style="color:#6272a4">// 否则直接作为函数调用
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">14</span>             invoker.value(e)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>           }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>         invoker.value <span style="color:#ff79c6">=</span> nextValue
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>         el.addEventListener(name, invoker)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>       } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>         invoker.value <span style="color:#ff79c6">=</span> nextValue
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>     } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (invoker) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>       el.removeEventListener(name, invoker)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">24</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (key <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;class&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">27</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (shouldSetAsProps(el, key, nextValue)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">29</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">30</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">31</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">32</span> }
</span></span></code></pre></div><h3 id="处理冒泡">处理冒泡</h3>
<p>一个例子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">const</span> { effect, ref } <span style="color:#ff79c6">=</span> VueReactivity
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span> <span style="color:#ff79c6">const</span> bol <span style="color:#ff79c6">=</span> ref(<span style="color:#ff79c6">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span> effect(() =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>   <span style="color:#6272a4">// 创建 vnode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">07</span>   <span style="color:#ff79c6">const</span> vnode <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>     type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;div&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>     props<span style="color:#ff79c6">:</span> bol.value <span style="color:#ff79c6">?</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>       onClick<span style="color:#ff79c6">:</span> () =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>         alert(<span style="color:#f1fa8c">&#39;父元素 clicked&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>     } <span style="color:#ff79c6">:</span> {},
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>     children<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>       {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>         type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;p&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>         props<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>           onClick<span style="color:#ff79c6">:</span> () =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>             bol.value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>           }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>         },
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>         children<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;text&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">24</span>     ]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>   <span style="color:#6272a4">// 渲染 vnode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">27</span>   renderer.render(vnode, <span style="color:#8be9fd;font-style:italic">document</span>.querySelector(<span style="color:#f1fa8c">&#39;#app&#39;</span>))
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span> })
</span></span></code></pre></div><p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=MzM3OTNhMjliNzU5MDgzMWYxOWY2NTIxMGYyYzdlNTlfWnFRalZPazFNeWNFa0FlMnJDRzczdnJ1MVdjY1lEQkJfVG9rZW46Ym94Y25tdnNGTzBTdXlSY0VheTRHYnMyV1ljXzE2NzcyNDU0MDA6MTY3NzI0OTAwMF9WNA" alt="">

</p>
<p>当点击 p 元素时，绑定到它身上的 click 事件处理函数会执行，于是 bol.value 的值被改为 true。接下来的一步非常关键，由于 bol 是一个响应式数据，所以当它的值发生变化时，会触发副作用函数重新执行。由于此时的 bol.value 已经变成了true，所以在更新阶段，渲染器会为父级 div 元素绑定 click 事件处理函数。当更新完成之后，点击事件才从 p 元素冒泡到父级 div 元素。</p>
<p>解决方法：屏蔽所有绑定时间晚于事件触发时间的事件处理函数的执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> patchProps(el, key, prevValue, nextValue) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#f1fa8c">/^on/</span>.test(key)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#ff79c6">const</span> invokers <span style="color:#ff79c6">=</span> el._vei <span style="color:#ff79c6">||</span> (el._vei <span style="color:#ff79c6">=</span> {})
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>     <span style="color:#8be9fd;font-style:italic">let</span> invoker <span style="color:#ff79c6">=</span> invokers[key]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#ff79c6">const</span> name <span style="color:#ff79c6">=</span> key.slice(<span style="color:#bd93f9">2</span>).toLowerCase()
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#ff79c6">if</span> (nextValue) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>       <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>invoker) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>         invoker <span style="color:#ff79c6">=</span> el._vei[key] <span style="color:#ff79c6">=</span> (e) =&gt; {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>           <span style="color:#6272a4">// e.timeStamp 是事件发生的时间
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>           <span style="color:#6272a4">// 如果事件发生的时间早于事件处理函数绑定的时间，则不执行事件处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">11</span>           <span style="color:#ff79c6">if</span> (e.timeStamp <span style="color:#ff79c6">&lt;</span> invoker.attached) <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>           <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(invoker.value)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>             invoker.value.forEach(fn =&gt; fn(e))
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>           } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>             invoker.value(e)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>           }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>         invoker.value <span style="color:#ff79c6">=</span> nextValue
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>         <span style="color:#6272a4">// 添加 invoker.attached 属性，存储事件处理函数被绑定的时间
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">20</span>         invoker.attached <span style="color:#ff79c6">=</span> performance.now()
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>         el.addEventListener(name, invoker)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>       } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>         invoker.value <span style="color:#ff79c6">=</span> nextValue
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">24</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>     } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (invoker) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>       el.removeEventListener(name, invoker)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">27</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (key <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;class&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">30</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (shouldSetAsProps(el, key, nextValue)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">31</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">32</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">33</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">34</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">35</span> }
</span></span></code></pre></div><p>新旧节点的更新</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> patchChildren(n1, n2, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> n2.children <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n1.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>       n1.children.forEach((c) =&gt; unmount(c))
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     setElementText(container, n2.children)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n2.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>     <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n1.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>       <span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>     } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>       setElementText(container, <span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>       n2.children.forEach(c =&gt; patch(<span style="color:#ff79c6">null</span>, c, container))
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>     <span style="color:#6272a4">// 代码运行到这里，说明新子节点不存在
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">16</span>     <span style="color:#6272a4">// 旧子节点是一组子节点，只需逐个卸载即可
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">17</span>     <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n1.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>       n1.children.forEach(c =&gt; unmount(c))
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>     } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> n1.children <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>       <span style="color:#6272a4">// 旧子节点是文本子节点，清空内容即可
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">21</span>       setElementText(container, <span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>     <span style="color:#6272a4">// 如果也没有旧子节点，那么什么都不需要做
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">24</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span> }
</span></span></code></pre></div><h3 id="vnodechildren属性的三种类型">vnode.children属性的三种类型</h3>
<ul>
<li>
<p>字符串类型：代表元素具有文本子节点。</p>
</li>
<li>
<p>数组类型：代表元素具有一组子节点。</p>
</li>
<li>
<p>null：代表元素没有子节点。</p>
</li>
</ul>
<h3 id="fragment-及其用途">Fragment 及其用途</h3>
<p>渲染器渲染 Fragment 的方式类似于渲染普通标签，不同的是，Fragment 本身并不会渲染任何 DOM 元素。所以，只需要渲染一个 Fragment 的所有子节点即可</p>
<h2 id="简单diff算法">简单diff算法</h2>
<h3 id="节点复用">节点复用</h3>
<h4 id="更新">更新</h4>
<ul>
<li>
<p>通过key 来确定是否是同一个节点，才能在<code>vnode.type</code>相同时实现节点的排序 &ndash; <strong>减少DOM的挂载和卸载操作</strong></p>
</li>
<li>
<p>即使节点的key相同，我们也需要对同一个节点的内容进行patch操作</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> patchChildren(n1, n2, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> n2.children <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">04</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n2.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#ff79c6">const</span> oldChildren <span style="color:#ff79c6">=</span> n1.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#ff79c6">const</span> newChildren <span style="color:#ff79c6">=</span> n2.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>     <span style="color:#6272a4">// 遍历新的 children
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">09</span>     <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> newChildren.length; i<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>       <span style="color:#ff79c6">const</span> newVNode <span style="color:#ff79c6">=</span> newChildren[i]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>       <span style="color:#6272a4">// 遍历旧的 children
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">12</span>       <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> j <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; j <span style="color:#ff79c6">&lt;</span> oldChildren.length; j<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>         <span style="color:#ff79c6">const</span> oldVNode <span style="color:#ff79c6">=</span> oldChildren[j]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>         <span style="color:#6272a4">// 如果找到了具有相同 key 值的两个节点，说明可以复用，但仍然需要调用 patch 函数更新
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">15</span>         <span style="color:#ff79c6">if</span> (newVNode.key <span style="color:#ff79c6">===</span> oldVNode.key) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>           patch(oldVNode, newVNode, container)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>           <span style="color:#ff79c6">break</span> <span style="color:#6272a4">// 这里需要 break
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">18</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">24</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span> }
</span></span></code></pre></div><h4 id="排序">排序</h4>
<p>我们将新旧节点中的可以复用的节点内容都更新了， 但是现在还是保持着原来旧节点的顺序，接下来就需要让旧节点的顺序和新节点一致。</p>
<p>前置条件：</p>
<ul>
<li>新旧节点都存在对真实DOM节点的引用</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> patchChildren(n1, n2, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> n2.children <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">04</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n2.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#ff79c6">const</span> oldChildren <span style="color:#ff79c6">=</span> n1.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#ff79c6">const</span> newChildren <span style="color:#ff79c6">=</span> n2.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>     <span style="color:#8be9fd;font-style:italic">let</span> lastIndex <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>     <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> newChildren.length; i<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>       <span style="color:#ff79c6">const</span> newVNode <span style="color:#ff79c6">=</span> newChildren[i]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>       <span style="color:#8be9fd;font-style:italic">let</span> j <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>       <span style="color:#ff79c6">for</span> (j; j <span style="color:#ff79c6">&lt;</span> oldChildren.length; j<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>         <span style="color:#ff79c6">const</span> oldVNode <span style="color:#ff79c6">=</span> oldChildren[j]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>         <span style="color:#ff79c6">if</span> (newVNode.key <span style="color:#ff79c6">===</span> oldVNode.key) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>           patch(oldVNode, newVNode, container)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>           <span style="color:#ff79c6">if</span> (j <span style="color:#ff79c6">&lt;</span> lastIndex) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>             <span style="color:#6272a4">// 代码运行到这里，说明 newVNode 对应的真实 DOM 需要移动
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">18</span>             <span style="color:#6272a4">// 先获取 newVNode 的前一个 vnode，即 prevVNode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">19</span>             <span style="color:#ff79c6">const</span> prevVNode <span style="color:#ff79c6">=</span> newChildren[i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>             <span style="color:#6272a4">// 如果 prevVNode 不存在，则说明当前 newVNode 是第一个节点，它不需要移动
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">21</span>             <span style="color:#ff79c6">if</span> (prevVNode) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>               <span style="color:#6272a4">// 由于我们要将 newVNode 对应的真实 DOM 移动到 prevVNode 所对应真实 DOM 后面，
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">23</span>               <span style="color:#6272a4">// 所以我们需要获取 prevVNode 所对应真实 DOM 的下一个兄弟节点，并将其作为锚点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">24</span>               <span style="color:#ff79c6">const</span> anchor <span style="color:#ff79c6">=</span> prevVNode.el.nextSibling
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>               <span style="color:#6272a4">// 调用 insert 方法将 newVNode 对应的真实 DOM 插入到锚点元素前面，
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">26</span>               <span style="color:#6272a4">// 也就是 prevVNode 对应真实 DOM 的后面
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">27</span>               insert(newVNode.el, container, anchor)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span>             }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>           } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">30</span>             lastIndex <span style="color:#ff79c6">=</span> j
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">31</span>           }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">32</span>           <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">33</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">34</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">35</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">36</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">37</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">38</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">39</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">40</span> }
</span></span></code></pre></div><h5 id="处理新节点">处理新节点</h5>
<p>循环的时候可以通过循环的下标得到<strong>新的一组节点的位置信息</strong>，可以通过它来确定<strong>新增节点</strong>的插入位置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> patchChildren(n1, n2, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">typeof</span> n2.children <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">04</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">Array</span>.isArray(n2.children)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#ff79c6">const</span> oldChildren <span style="color:#ff79c6">=</span> n1.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#ff79c6">const</span> newChildren <span style="color:#ff79c6">=</span> n2.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>     <span style="color:#8be9fd;font-style:italic">let</span> lastIndex <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>     <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> newChildren.length; i<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>       <span style="color:#ff79c6">const</span> newVNode <span style="color:#ff79c6">=</span> newChildren[i]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>       <span style="color:#8be9fd;font-style:italic">let</span> j <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>       <span style="color:#6272a4">// 在第一层循环中定义变量 find，代表是否在旧的一组子节点中找到可复用的节点，
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">13</span>       <span style="color:#6272a4">// 初始值为 false，代表没找到
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">14</span>       <span style="color:#8be9fd;font-style:italic">let</span> find <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>       <span style="color:#ff79c6">for</span> (j; j <span style="color:#ff79c6">&lt;</span> oldChildren.length; j<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>         <span style="color:#ff79c6">const</span> oldVNode <span style="color:#ff79c6">=</span> oldChildren[j]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>         <span style="color:#ff79c6">if</span> (newVNode.key <span style="color:#ff79c6">===</span> oldVNode.key) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>           <span style="color:#6272a4">// 一旦找到可复用的节点，则将变量 find 的值设为 true
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">19</span>           find <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>           patch(oldVNode, newVNode, container)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>           <span style="color:#ff79c6">if</span> (j <span style="color:#ff79c6">&lt;</span> lastIndex) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>             <span style="color:#ff79c6">const</span> prevVNode <span style="color:#ff79c6">=</span> newChildren[i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>             <span style="color:#ff79c6">if</span> (prevVNode) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">24</span>               <span style="color:#ff79c6">const</span> anchor <span style="color:#ff79c6">=</span> prevVNode.el.nextSibling
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>               insert(newVNode.el, container, anchor)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>             }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">27</span>           } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span>             lastIndex <span style="color:#ff79c6">=</span> j
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>           }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">30</span>           <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">31</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">32</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">33</span>       <span style="color:#6272a4">// 如果代码运行到这里，find 仍然为 false，
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">34</span>       <span style="color:#6272a4">// 说明当前 newVNode 没有在旧的一组子节点中找到可复用的节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">35</span>       <span style="color:#6272a4">// 也就是说，当前 newVNode 是新增节点，需要挂载
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">36</span>       <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>find) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">37</span>         <span style="color:#6272a4">// 为了将节点挂载到正确位置，我们需要先获取锚点元素
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">38</span>         <span style="color:#6272a4">// 首先获取当前 newVNode 的前一个 vnode 节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">39</span>         <span style="color:#ff79c6">const</span> prevVNode <span style="color:#ff79c6">=</span> newChildren[i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">40</span>         <span style="color:#8be9fd;font-style:italic">let</span> anchor <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">41</span>         <span style="color:#ff79c6">if</span> (prevVNode) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">42</span>           <span style="color:#6272a4">// 如果有前一个 vnode 节点，则使用它的下一个兄弟节点作为锚点元素
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">43</span>           anchor <span style="color:#ff79c6">=</span> prevVNode.el.nextSibling
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">44</span>         } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">45</span>           <span style="color:#6272a4">// 如果没有前一个 vnode 节点，说明即将挂载的新节点是第一个子节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">46</span>           <span style="color:#6272a4">// 这时我们使用容器元素的 firstChild 作为锚点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">47</span>           anchor <span style="color:#ff79c6">=</span> container.firstChild
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">48</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">49</span>         <span style="color:#6272a4">// 挂载 newVNode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">50</span>         patch(<span style="color:#ff79c6">null</span>, newVNode, container, anchor)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">51</span>       }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">52</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">53</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">54</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">55</span>     <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">56</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">57</span> }
</span></span></code></pre></div><p>简单 Diff 算法的核心逻辑是，拿新的一组子节点中的节点去旧的一组子节点中寻找可复用的节点。如果找到了，则记录该节点的位置索引。我们把这个位置索引称为<strong>最大索引</strong>。在整个更新过程中，如果一个节点的索引值小于最大索引，则说明该节点对应的真实DOM 元素需要移动。</p>
<h2 id="双端diff算法">双端diff算法</h2>
<p>出现的原因：简单diff算法的结果并不是最优的。</p>
<h3 id="所需信息">所需信息</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> patchKeyedChildren(n1, n2, container) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">const</span> oldChildren <span style="color:#ff79c6">=</span> n1.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>   <span style="color:#ff79c6">const</span> newChildren <span style="color:#ff79c6">=</span> n2.children
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>   <span style="color:#6272a4">// 四个索引值
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">05</span>   <span style="color:#8be9fd;font-style:italic">let</span> oldStartIdx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>   <span style="color:#8be9fd;font-style:italic">let</span> oldEndIdx <span style="color:#ff79c6">=</span> oldChildren.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>   <span style="color:#8be9fd;font-style:italic">let</span> newStartIdx <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>   <span style="color:#8be9fd;font-style:italic">let</span> newEndIdx <span style="color:#ff79c6">=</span> newChildren.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>   <span style="color:#6272a4">// 四个索引指向的 vnode 节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>   <span style="color:#8be9fd;font-style:italic">let</span> oldStartVNode <span style="color:#ff79c6">=</span> oldChildren[oldStartIdx]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>   <span style="color:#8be9fd;font-style:italic">let</span> oldEndVNode <span style="color:#ff79c6">=</span> oldChildren[oldEndIdx]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>   <span style="color:#8be9fd;font-style:italic">let</span> newStartVNode <span style="color:#ff79c6">=</span> newChildren[newStartIdx]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>   <span style="color:#8be9fd;font-style:italic">let</span> newEndVNode <span style="color:#ff79c6">=</span> newChildren[newEndIdx]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span> }
</span></span></code></pre></div><p>处理遗漏和删除的情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">while</span> (oldStartIdx <span style="color:#ff79c6">&lt;=</span> oldEndIdx <span style="color:#ff79c6">&amp;&amp;</span> newStartIdx <span style="color:#ff79c6">&lt;=</span> newEndIdx) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">03</span> }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span> <span style="color:#ff79c6">if</span> (oldEndIdx <span style="color:#ff79c6">&lt;</span> oldStartIdx <span style="color:#ff79c6">&amp;&amp;</span> newStartIdx <span style="color:#ff79c6">&lt;=</span> newEndIdx) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>   <span style="color:#6272a4">// 添加新节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">07</span>   <span style="color:#6272a4">// 省略部分代码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">08</span> } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (newEndIdx <span style="color:#ff79c6">&lt;</span> newStartIdx <span style="color:#ff79c6">&amp;&amp;</span> oldStartIdx <span style="color:#ff79c6">&lt;=</span> oldEndIdx) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>   <span style="color:#6272a4">// 移除操作
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">10</span>   <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> oldStartIdx; i <span style="color:#ff79c6">&lt;=</span> oldEndIdx; i<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span>     unmount(oldChildren[i])
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span> } 
</span></span></code></pre></div><p>双端 Diff 算法指的是，在新旧两组子节点的四个端点之间分别进行比较，并试图找到可复用的节点。相比简单 Diff 算法，双端 Diff 算法的优势在于，对于同样的更新场景，执行的DOM 移动操作次数更少。</p>
<h2 id="快速diff算法">快速diff算法</h2>
<blockquote>
<p>具体的讲解见书第11章，有大量例子辅助说明</p>
</blockquote>
<p>快速 Diff 算法在实测中性能最优。它借鉴了文本 Diff 中的预处理思路，先处理新旧两组子节点中相同的前置节点和相同的后置节点。当前置节点和后置节点全部处理完毕后，如果无法简单地通过挂载新节点或者卸载已经不存在的节点来完成更新，<strong>则需要根据节点的索引关系，构造出一个最长递增子序列。最长递增子序列所指向的节点即为不需要移动的节点。</strong></p>


                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="https://kcfuler.github.io"><img src="/img/favicon.png" />Kcfuler Blog</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2023/02/23/vuejs-component/" data-toggle="tooltip" data-placement="top" title="Vue的组件化">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>
                

                



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href="https://cloudmoonocus.github.io">cloudmoon</a></li>
                        
                        <li><a target="_blank" href="https://github.com/shinyina">shinyina</a></li>
                        
                        <li><a target="_blank" href="https://github.com/L-H-X">Juns</a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:2842961263@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat_qrcode.png">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/kcfuler">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Kcfuler Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Kcfuler Blog 2023
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
