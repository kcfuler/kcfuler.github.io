<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Kcfuler Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://dogefs.s3.ladydaily.com/~/source/unsplash/photo-1676985086410-243e288378a3?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=880&amp;q=80">
    <meta property="twitter:image" content="https://dogefs.s3.ladydaily.com/~/source/unsplash/photo-1676985086410-243e288378a3?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=880&amp;q=80" />
    

    
    <meta name="title" content="Vue的编译器" />
    <meta property="og:title" content="Vue的编译器" />
    <meta property="twitter:title" content="Vue的编译器" />
    

    
    <meta name="description" content="vue编译器原理与实现方案">
    <meta property="og:description" content="vue编译器原理与实现方案" />
    <meta property="twitter:description" content="vue编译器原理与实现方案" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="柯昌鹏, KeChangePeng, keChangePeng, , 柯昌鹏的网络日志, 柯昌鹏的博客, KeChangePeng Blog, 博客, 个人网站, 互联网, Web">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Vue的编译器 | 柯昌鹏的博客 | kcfuler Blog</title>

    <link rel="canonical" href="/2023/02/26/vuejs-compiler/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>






<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Kcfuler Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/life">life</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/about/">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('https://dogefs.s3.ladydaily.com/~/source/unsplash/photo-1676985086410-243e288378a3?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=880&q=80')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                    </div>
                    <h1>Vue的编译器</h1>
                    <h2 class="subheading">Vue.js设计与实现读书笔记</h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                kcfuler
                             
                            on 
                            Sunday, February 26, 2023
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="编译器核心技术概览">编译器核心技术概览</h2>
<h3 id="模板dsl的编辑器">模板DSL的编辑器</h3>
<p>编译器其实只是一段程序，它用来将“一种语言 A”翻译成“另外一种语言 B”。其中，语言 A 通常叫作源代码（source code），语言 B 通常叫作目标代码（object code 或 target code）。编译器将源代码翻译为目标代码的过程叫作编译（compile）。完整的编译过程通常包含词法分析、语法分析、语义分析、中间代码生成、优化、目标代码生成等步骤，如图 15-1 所示。</p>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=NWI5NmI3MjIwYjI2ZWNjODQwOGQ0ZTg4MWJjZTk2YWFfYW5rQkZkVXBSc25mZnJrZVhJaEJ1NXB1Qmt0VmxpUHRfVG9rZW46Ym94Y25rSlVSNFZ2bGVxbDFOSExyQU5qdkFiXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>完整的编译过程可以看到，整个编译过程分为编译前端和编译后端。编译前端包含词法分析、语法分析和语义分析，它通常与目标平台无关，仅负责分析源代码。编译后端则通常与目标平台有关，编译后端涉及中间代码生成和优化以及目标代码生成。但是，编译后端并不一定会包含中间代码生成和优化这两个环节，这取决于具体的场景和实现。中间代码生成和优化这两个环节有时也叫“中端”。</p>
<p>对于 Vue.js 模板编译器来说，源代码就是组件的模板，而目标代码是能够在浏览器平台上运行的 JavaScript 代码，或其他拥有 JavaScript 运行时的平台代码，如下图所示</p>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=ODVjY2E5Zjc4ZjUwODljZTcxM2YxMTA3N2NjMmY5NWVfemYxamsxSW1ISDZlYWI1UFAzb01sT2E1QllkalVhd29fVG9rZW46Ym94Y25HMnVxaHIxaEdVQ2tLcUhmU3diVHhlXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=YmExNWU1N2YzYThmM2IxZmVjNTIyZmVlNDY3Y2NiM2VfOXljWDRsZU5Ockw0RjBxR1ZiMHBaZDNIWERER3R5dGRfVG9rZW46Ym94Y25PcE1MdTVhcGVJaW1sMDVQdlBBRU9nXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>AST 是 abstract syntax tree 的首字母缩写，即抽象语法树。所谓模板 AST，其实就是用来描述模板的抽象语法树。</p>
<p>举个例子，假设我们有如下模板：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">&lt;</span>div<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">&lt;</span>h1 v<span style="color:#ff79c6">-</span><span style="color:#ff79c6">if</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;ok&#34;</span><span style="color:#ff79c6">&gt;</span>Vue Template<span style="color:#ff79c6">&lt;</span>/h1&gt;
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span> <span style="color:#ff79c6">&lt;</span>/div&gt;
</span></span></code></pre></div><p>这段模板会被编译为如下所示的 AST：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">const</span> ast <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#6272a4">// 逻辑根节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">03</span>   type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Root&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>   children<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>     <span style="color:#6272a4">// div 标签节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">06</span>     {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>       type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Element&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>       tag<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;div&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>       children<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>         <span style="color:#6272a4">// h1 标签节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">11</span>         {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>           type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Element&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span>           tag<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;h1&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>           props<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>             <span style="color:#6272a4">// v-if 指令节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">16</span>             {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>               type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Directive&#39;</span>, <span style="color:#6272a4">// 类型为 Directive 代表指令
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">18</span>               name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;if&#39;</span>，       <span style="color:#6272a4">// 指令名称为 if，不带有前缀 v-
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">19</span>               exp<span style="color:#ff79c6">:</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>                 <span style="color:#6272a4">// 表达式节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">21</span>                 type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Expression&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>                 content<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;ok&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>               }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">24</span>             }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>           ]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">27</span>       ]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>   ]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">30</span> }
</span></span></code></pre></div><p>可以看到，AST 其实就是一个具有层级结构的对象。模板 AST 具有与模板同构的嵌套结构。每一棵 AST 都有一个逻辑上的根节点，其类型为 Root。模板中真正的根节点则作为 Root 节点的 children 存在。观察上面的 AST，我们可以得出如下结论。</p>
<ul>
<li>
<p>不同类型的节点是通过节点的 type 属性进行区分的。例如标签节点的 type 值为 &lsquo;Element&rsquo;。</p>
</li>
<li>
<p>标签节点的子节点存储在其 children 数组中。</p>
</li>
<li>
<p>标签节点的属性节点和指令节点会存储在 props 数组中。</p>
</li>
<li>
<p>不同类型的节点会使用不同的对象属性进行描述。例如指令节点拥有 name 属性，用来表达指令的名称，而表达式节点拥有 content 属性，用来描述表达式的内容。</p>
</li>
</ul>
<ol>
<li>我们可以通过封装 parse 函数来完成对模板的词法分析和语法分析，得到模板AST，如图 15-4 所示。</li>
</ol>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=OWE3YTZjMjY1OTNjZmU2OWM0ODRlMTU2ZWNjODkyYzlfcFVRaE9xUVAxWU5mb2RhY2ZXYTBMNnk1RElUVzJXSzVfVG9rZW46Ym94Y25DNldxOGRtd0lrQ2M0QjQ4OVQ5dUdoXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>我们也可以用下面的代码来表达模板解析的过程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">const</span> template <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">02   &lt;div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">03     &lt;h1 v-if=&#34;ok&#34;&gt;Vue Template&lt;/h1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">04   &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">05 `</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span> <span style="color:#ff79c6">const</span> templateAST <span style="color:#ff79c6">=</span> parse(template)
</span></span></code></pre></div><p>可以看到，parse 函数接收字符串模板作为参数，并将解析后得到的 AST 作为返回值返回。有了模板 AST 后，我们就可以对其进行语义分析，并对模板 AST 进行转换了。什么是语义分析呢？举几个例子。</p>
<ul>
<li>
<p>检查 v-else 指令是否存在相符的 v-if 指令。</p>
</li>
<li>
<p>分析属性值是否是静态的，是否是常量等。</p>
</li>
<li>
<p>插槽是否会引用上层作用域的变量。</p>
</li>
<li>
<p>……</p>
</li>
</ul>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=MjU4YTU3YzU5MTM3YzA1MDVmNjRkYjgzM2Q0NWJkNGRfQUVaa3d4bUtWWFFzbTQ5QUtIQkdRRzl5bXpNQWhLekdfVG9rZW46Ym94Y244UVlxTWpvYUZ5NHlFODU4a0U3MXJkXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>将 Vue.js 模板编译为渲染函数的完整流程</p>
<ul>
<li>
<p>用来将模板字符串解析为模板 AST 的解析器（parser）</p>
</li>
<li>
<p>用来将模板 AST 转换为 JavaScript AST 的转换器（transformer）</p>
</li>
<li>
<p>用来根据 JavaScript AST 生成渲染函数代码的生成器（generator）。</p>
</li>
</ul>
<h3 id="解析器">解析器</h3>
<p>解析器的入参是字符串模板，解析器会逐个读取字符串模板中的字符，并根据一定的规则将整个字符串切割为一个个 Token。这里的 Token 可以视作词法记号。</p>
<p>假设有这样一段模板：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">&lt;</span>p<span style="color:#ff79c6">&gt;</span>Vue<span style="color:#ff79c6">&lt;</span>/p&gt;
</span></span></code></pre></div><p>解析器会把这段字符串切割为以下三个部分：</p>
<ul>
<li>
<p>开始标签：<!-- raw HTML omitted -->。</p>
</li>
<li>
<p>文本节点：Vue。</p>
</li>
<li>
<p>结束标签：<!-- raw HTML omitted -->。</p>
</li>
</ul>
<p>那么，解析器是如何对模板进行切割的呢？依据什么规则？这就不得不提到有限状态自动机。千万不要被这个名词吓到，它理解起来并不难。所谓“有限状态”，就是指有限个状态，而“自动机”意味着随着字符的输入，解析器会自动地在不同状态间迁移。拿上面的模板来说，当我们分析这段模板字符串时，parse 函数会逐个读取字符，状态机会有一个初始状态，我们记为“初始状态 1”。图 15-8 给出了状态迁移的过程。</p>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=N2JlY2Y2NDlkZGMxNDExNDI5YWM5MzU0MjYwNDA1NmVfa3NPVFZzQldoUWdJdTlvQzVIY0k4Rkx1ZkZLOUF2aXZfVG9rZW46Ym94Y25ZZ2ZWSW9qcDY2SEc5NHBvWEtmQklkXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>经过这样一系列的状态迁移过程之后，我们最终就能够得到相应的 Token 了。有的圆圈是单线的，而有的圆圈是双线的。双线代表此时状态机是一个合法的 Token。</p>
<p>状态机的简易实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#6272a4">// 定义状态机的状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">02</span> <span style="color:#ff79c6">const</span> State <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>   initial<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1</span>,    <span style="color:#6272a4">// 初始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">04</span>   tagOpen<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">2</span>,    <span style="color:#6272a4">// 标签开始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">05</span>   tagName<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">3</span>,    <span style="color:#6272a4">// 标签名称状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">06</span>   text<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">4</span>,       <span style="color:#6272a4">// 文本状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">07</span>   tagEnd<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">5</span>,     <span style="color:#6272a4">// 结束标签状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">08</span>   tagEndName<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">6</span>  <span style="color:#6272a4">// 结束标签名称状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">09</span> }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span> <span style="color:#6272a4">// 一个辅助函数，用于判断是否是字母
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">11</span> <span style="color:#8be9fd;font-style:italic">function</span> isAlpha(<span style="color:#ff79c6">char</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">12</span>   <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">char</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#f1fa8c">&#39;a&#39;</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">char</span> <span style="color:#ff79c6">&lt;=</span> <span style="color:#f1fa8c">&#39;z&#39;</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">char</span> <span style="color:#ff79c6">&gt;=</span> <span style="color:#f1fa8c">&#39;A&#39;</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">char</span> <span style="color:#ff79c6">&lt;=</span> <span style="color:#f1fa8c">&#39;Z&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">13</span> }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span> <span style="color:#6272a4">// 接收模板字符串作为参数，并将模板切割为 Token 返回
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">16</span> <span style="color:#8be9fd;font-style:italic">function</span> tokenize(str) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>   <span style="color:#6272a4">// 状态机的当前状态：初始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">18</span>   <span style="color:#8be9fd;font-style:italic">let</span> currentState <span style="color:#ff79c6">=</span> State.initial
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>   <span style="color:#6272a4">// 用于缓存字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">20</span>   <span style="color:#ff79c6">const</span> chars <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>   <span style="color:#6272a4">// 生成的 Token 会存储到 tokens 数组中，并作为函数的返回值返回
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">22</span>   <span style="color:#ff79c6">const</span> tokens <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>   <span style="color:#6272a4">// 使用 while 循环开启自动机，只要模板字符串没有被消费尽，自动机就会一直运行
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">24</span>   <span style="color:#ff79c6">while</span>(str) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>     <span style="color:#6272a4">// 查看第一个字符，注意，这里只是查看，没有消费该字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">26</span>     <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">char</span> <span style="color:#ff79c6">=</span> str[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">27</span>     <span style="color:#6272a4">// switch 语句匹配当前状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">28</span>     <span style="color:#ff79c6">switch</span> (currentState) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>       <span style="color:#6272a4">// 状态机当前处于初始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">30</span>       <span style="color:#ff79c6">case</span> State.initial<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">31</span>         <span style="color:#6272a4">// 遇到字符 &lt;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">32</span>         <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">char</span> <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;&lt;&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">33</span>           <span style="color:#6272a4">// 1. 状态机切换到标签开始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">34</span>           currentState <span style="color:#ff79c6">=</span> State.tagOpen
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">35</span>           <span style="color:#6272a4">// 2. 消费字符 &lt;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">36</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">37</span>         } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (isAlpha(<span style="color:#ff79c6">char</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">38</span>           <span style="color:#6272a4">// 1. 遇到字母，切换到文本状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">39</span>           currentState <span style="color:#ff79c6">=</span> State.text
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">40</span>           <span style="color:#6272a4">// 2. 将当前字母缓存到 chars 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">41</span>           chars.push(<span style="color:#ff79c6">char</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">42</span>           <span style="color:#6272a4">// 3. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">43</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">44</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">45</span>         <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">46</span>       <span style="color:#6272a4">// 状态机当前处于标签开始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">47</span>       <span style="color:#ff79c6">case</span> State.tagOpen<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">48</span>         <span style="color:#ff79c6">if</span> (isAlpha(<span style="color:#ff79c6">char</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">49</span>           <span style="color:#6272a4">// 1. 遇到字母，切换到标签名称状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">50</span>           currentState <span style="color:#ff79c6">=</span> State.tagName
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">51</span>           <span style="color:#6272a4">// 2. 将当前字符缓存到 chars 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">52</span>           chars.push(<span style="color:#ff79c6">char</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">53</span>           <span style="color:#6272a4">// 3. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">54</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">55</span>         } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">char</span> <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;/&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">56</span>           <span style="color:#6272a4">// 1. 遇到字符 /，切换到结束标签状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">57</span>           currentState <span style="color:#ff79c6">=</span> State.tagEnd
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">58</span>           <span style="color:#6272a4">// 2. 消费字符 /
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">59</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">60</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">61</span>         <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">62</span>       <span style="color:#6272a4">// 状态机当前处于标签名称状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">63</span>       <span style="color:#ff79c6">case</span> State.tagName<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">64</span>         <span style="color:#ff79c6">if</span> (isAlpha(<span style="color:#ff79c6">char</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">65</span>           <span style="color:#6272a4">// 1. 遇到字母，由于当前处于标签名称状态，所以不需要切换状态，
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">66</span>           <span style="color:#6272a4">// 但需要将当前字符缓存到 chars 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">67</span>           chars.push(<span style="color:#ff79c6">char</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">68</span>           <span style="color:#6272a4">// 2. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">69</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">70</span>         } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">char</span> <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;&gt;&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">71</span>           <span style="color:#6272a4">// 1.遇到字符 &gt;，切换到初始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">72</span>           currentState <span style="color:#ff79c6">=</span> State.initial
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">73</span>           <span style="color:#6272a4">// 2. 同时创建一个标签 Token，并添加到 tokens 数组中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">74</span>           <span style="color:#6272a4">// 注意，此时 chars 数组中缓存的字符就是标签名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">75</span>           tokens.push({
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">76</span>             type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;tag&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">77</span>             name<span style="color:#ff79c6">:</span> chars.join(<span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">78</span>           })
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">79</span>           <span style="color:#6272a4">// 3. chars 数组的内容已经被消费，清空它
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">80</span>           chars.length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">81</span>           <span style="color:#6272a4">// 4. 同时消费当前字符 &gt;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">82</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">83</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">84</span>         <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">85</span>       <span style="color:#6272a4">// 状态机当前处于文本状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">86</span>       <span style="color:#ff79c6">case</span> State.text<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">87</span>         <span style="color:#ff79c6">if</span> (isAlpha(<span style="color:#ff79c6">char</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">88</span>           <span style="color:#6272a4">// 1. 遇到字母，保持状态不变，但应该将当前字符缓存到 chars 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">89</span>           chars.push(<span style="color:#ff79c6">char</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">90</span>           <span style="color:#6272a4">// 2. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">91</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">92</span>         } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">char</span> <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;&lt;&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">93</span>           <span style="color:#6272a4">// 1. 遇到字符 &lt;，切换到标签开始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">94</span>           currentState <span style="color:#ff79c6">=</span> State.tagOpen
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">95</span>           <span style="color:#6272a4">// 2. 从 文本状态 --&gt; 标签开始状态，此时应该创建文本 Token，并添加到 tokens 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">96</span>           <span style="color:#6272a4">// 注意，此时 chars 数组中的字符就是文本内容
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">97</span>           tokens.push({
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">98</span>             type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;text&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">99</span>             content<span style="color:#ff79c6">:</span> chars.join(<span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">100</span>           })
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">101</span>           <span style="color:#6272a4">// 3. chars 数组的内容已经被消费，清空它
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">102</span>           chars.length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">103</span>           <span style="color:#6272a4">// 4. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">104</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">105</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">106</span>         <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">107</span>       <span style="color:#6272a4">// 状态机当前处于标签结束状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">108</span>       <span style="color:#ff79c6">case</span> State.tagEnd<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">109</span>         <span style="color:#ff79c6">if</span> (isAlpha(<span style="color:#ff79c6">char</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">110</span>           <span style="color:#6272a4">// 1. 遇到字母，切换到结束标签名称状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">111</span>           currentState <span style="color:#ff79c6">=</span> State.tagEndName
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">112</span>           <span style="color:#6272a4">// 2. 将当前字符缓存到 chars 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">113</span>           chars.push(<span style="color:#ff79c6">char</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">114</span>           <span style="color:#6272a4">// 3. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">115</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">116</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">117</span>         <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">118</span>       <span style="color:#6272a4">// 状态机当前处于结束标签名称状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">119</span>       <span style="color:#ff79c6">case</span> State.tagEndName<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">120</span>         <span style="color:#ff79c6">if</span> (isAlpha(<span style="color:#ff79c6">char</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">121</span>           <span style="color:#6272a4">// 1. 遇到字母，不需要切换状态，但需要将当前字符缓存到 chars 数组
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">122</span>           chars.push(<span style="color:#ff79c6">char</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">123</span>           <span style="color:#6272a4">// 2. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">124</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">125</span>         } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">char</span> <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;&gt;&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">126</span>           <span style="color:#6272a4">// 1. 遇到字符 &gt;，切换到初始状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">127</span>           currentState <span style="color:#ff79c6">=</span> State.initial
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">128</span>           <span style="color:#6272a4">// 2. 从 结束标签名称状态 --&gt; 初始状态，应该保存结束标签名称 Token
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">129</span>           <span style="color:#6272a4">// 注意，此时 chars 数组中缓存的内容就是标签名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">130</span>           tokens.push({
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">131</span>             type<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;tagEnd&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">132</span>             name<span style="color:#ff79c6">:</span> chars.join(<span style="color:#f1fa8c">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">133</span>           })
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">134</span>           <span style="color:#6272a4">// 3. chars 数组的内容已经被消费，清空它
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">135</span>           chars.length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">136</span>           <span style="color:#6272a4">// 4. 消费当前字符
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">137</span>           str <span style="color:#ff79c6">=</span> str.slice(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">138</span>         }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">139</span>         <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">140</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">141</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">142</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">143</span>   <span style="color:#6272a4">// 最后，返回 tokens
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">144</span>   <span style="color:#ff79c6">return</span> tokens
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">145</span> }
</span></span></code></pre></div><p>通过有限自动机，我们能够将模板解析为一个个 Token，进而可以用它们构建一棵 AST 了。但在具体构建 AST 之前，我们需要思考能否简化 tokenize 函数的代码。实际上，我们可以通过正则表达式来精简 tokenize 函数的代码。上文之所以没有从最开始就采用正则表达式来实现，是因为<strong>正则表达式的本质就是有限自动机</strong>。当你编写正则表达式的时候，其实就是在编写有限自动机。</p>
<h2 id="解析器-1">解析器</h2>
<p>文本模式指的是解析器在工作时所进入的一些特殊状态，在不同的特殊状态下，解析器对文本的解析行为会有所不同。具体来说，当解析器遇到一些特殊标签时，会切换模式，从而影响其对文本的解析行为。这些特殊标签是：</p>
<ul>
<li>
<!-- raw HTML omitted -->
</li>
<li>
<!-- raw HTML omitted -->
</li>
<li>
<p>当解析器遇到 &lt;![CDATA[ 字符串时，会进入 CDATA 模式。</p>
</li>
</ul>
<p>
  <img src="https://gb6tpk84yf.feishu.cn/space/api/box/stream/download/asynccode/?code=MWM2MWU1NWQ0M2U2OGQwZGZmZjBhYjY0NzViNDAxNGZfaXdRQWx0STh2Z3VIVk1vcU91eXhUMlpnUjlkTnBMNVBfVG9rZW46Ym94Y242QmRva2lnZ3lya2Rud0t2N3puMHBoXzE2Nzc0MDAxNjE6MTY3NzQwMzc2MV9WNA" alt="">

</p>
<p>将上述状态定义为代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#ff79c6">const</span> TextModes <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   DATA<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;DATA&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>   RCDATA<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;RCDATA&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>   RAWTEXT<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;RAWTEXT&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>   CDATA<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;CDATA&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span> }
</span></span></code></pre></div><h3 id="状态机的开启与停止">状态机的开启与停止</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> isEnd(context, ancestors) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#6272a4">// 当模板内容解析完毕后，停止
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">03</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>context.source) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>   <span style="color:#6272a4">// 获取父级标签节点
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">05</span>   <span style="color:#ff79c6">const</span> parent <span style="color:#ff79c6">=</span> ancestors[ancestors.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>   <span style="color:#6272a4">// 如果遇到结束标签，并且该标签与父级标签节点同名，则停止
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">07</span>   <span style="color:#ff79c6">if</span> (parent <span style="color:#ff79c6">&amp;&amp;</span> context.source.startsWith(<span style="color:#f1fa8c">`&lt;/</span><span style="color:#f1fa8c">${</span>parent.tag<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>     <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span> }
</span></span></code></pre></div><ul>
<li>
<p>第一个停止时机是当模板内容被解析完毕时；</p>
</li>
<li>
<p>第二个停止时机则是在遇到结束标签时，这时解析器会取得父级节点栈栈顶的节点作为父节点，检查该结束标签是否与父节点的标签同名，如果相同，则状态机停止运行。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> isEnd(context, ancestors) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>context.source) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>   <span style="color:#6272a4">// 与父级节点栈内所有节点做比较
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">05</span>   <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">let</span> i <span style="color:#ff79c6">=</span> ancestors.length <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>; i <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">--</span>i) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">06</span>     <span style="color:#6272a4">// 只要栈中存在与当前结束标签同名的节点，就停止状态机
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">07</span>     <span style="color:#ff79c6">if</span> (context.source.startsWith(<span style="color:#f1fa8c">`&lt;/</span><span style="color:#f1fa8c">${</span>ancestors[i].tag<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">08</span>       <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>     }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">11</span> }
</span></span></code></pre></div><h3 id="解析标签节点">解析标签节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#bd93f9">01</span> <span style="color:#8be9fd;font-style:italic">function</span> parseElement(context, ancestors) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">02</span>   <span style="color:#ff79c6">const</span> element <span style="color:#ff79c6">=</span> parseTag(context)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">03</span>   <span style="color:#ff79c6">if</span> (element.isSelfClosing) <span style="color:#ff79c6">return</span> element
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">04</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">05</span>   <span style="color:#6272a4">// 切换到正确的文本模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">06</span>   <span style="color:#ff79c6">if</span> (element.tag <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;textarea&#39;</span> <span style="color:#ff79c6">||</span> element.tag <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;title&#39;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">07</span>     <span style="color:#6272a4">// 如果由 parseTag 解析得到的标签是 &lt;textarea&gt; 或 &lt;title&gt;，则切换到 RCDATA 模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">08</span>     context.mode <span style="color:#ff79c6">=</span> TextModes.RCDATA
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">09</span>   } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> (<span style="color:#f1fa8c">/style|xmp|iframe|noembed|noframes|noscript/</span>.test(element.tag)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">10</span>     <span style="color:#6272a4">// 如果由 parseTag 解析得到的标签是：
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">11</span>     <span style="color:#6272a4">// &lt;style&gt;、&lt;xmp&gt;、&lt;iframe&gt;、&lt;noembed&gt;、&lt;noframes&gt;、&lt;noscript&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">12</span>     <span style="color:#6272a4">// 则切换到 RAWTEXT 模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">13</span>     context.mode <span style="color:#ff79c6">=</span> TextModes.RAWTEXT
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">14</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">15</span>     <span style="color:#6272a4">// 否则切换到 DATA 模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#bd93f9">16</span>     context.mode <span style="color:#ff79c6">=</span> TextModes.DATA
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">17</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">18</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">19</span>   ancestors.push(element)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">20</span>   element.children <span style="color:#ff79c6">=</span> parseChildren(context, ancestors)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">21</span>   ancestors.pop()
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">22</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">23</span>   <span style="color:#ff79c6">if</span> (context.source.startsWith(<span style="color:#f1fa8c">`&lt;/</span><span style="color:#f1fa8c">${</span>element.tag<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>)) {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">24</span>     parseTag(context, <span style="color:#f1fa8c">&#39;end&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">25</span>   } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">26</span>     console.error(<span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>element.tag<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> 标签缺少闭合标签`</span>)
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">27</span>   }
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">28</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">29</span>   <span style="color:#ff79c6">return</span> element
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">30</span> }
</span></span></code></pre></div><p>在本章中，我们首先讨论了解析器的文本模式及其对解析器的影响。文本模式指的是解析器在工作时所进入的一些特殊状态，如 RCDATA 模式、CDATA 模式、RAWTEXT 模式，以及初始的 DATA 模式等。在不同模式下，解析器对文本的解析行为会有所不同。</p>
<p>接着，我们讨论了如何使用递归下降算法构造模板 AST。在 parseChildren 函数运行的过程中，为了处理标签节点，会调用 parseElement 解析函数，这会间接地调用 parseChildren 函数，并产生一个新的状态机。随着标签嵌套层次的增加，新的状态机也会随着 parseChildren 函数被递归地调用而不断创建，这就是“递归下降”中“递归”二字的含义。而上级 parseChildren 函数的调用用于构造上级模板AST 节点，被递归调用的下级 parseChildren 函数则用于构造下级模板 AST 节点。最终会构造出一棵树型结构的模板 AST，这就是“递归下降”中“下降”二字的含义。</p>
<p>在解析模板构建 AST 的过程中，parseChildren 函数是核心。每次调用parseChildren 函数，就意味着新状态机的开启。状态机的结束时机有两个。</p>
<ul>
<li>
<p>第一个停止时机是当模板内容被解析完毕时。</p>
</li>
<li>
<p>第二个停止时机则是遇到结束标签时，这时解析器会取得父级节点栈栈顶的节点作为父节点，检查该结束标签是否与父节点的标签同名，如果相同，则状态机停止运行。我们还讨论了文本节点的解析。</p>
</li>
</ul>
<p>解析文本节点本身并不复杂，它的复杂点在于，我们需要对解析后的文本内容进行 HTML 实体的解码工作。WHATWG 规范中也定义了解码 HTML 实体过程中的状态迁移流程。HTML 实体类型有两种，分别是命名字符引用和数字字符引用。命名字符引用的解码方案可以总结为两种。</p>
<ul>
<li>
<p>当存在分号时：执行完整匹配。</p>
</li>
<li>
<p>当省略分号时：执行最短匹配。对于数字字符引用，则需要按照 WHATWG 规范中定义的规则逐步实现。</p>
</li>
</ul>
<h2 id="编译优化">编译优化</h2>
<p>编译优化指的是编译器将模板编译为渲染函数的过程中，尽可能多地提取关键信息，并以此指导生成最优代码的过程。</p>
<p>本章中，我们主要讨论了 Vue.js 3 在编译优化方面所做的努力。编译优化指的是通过编译的手段提取关键信息，并以此指导生成最优代码的过程。具体来说，Vue.js 3 的编译器会充分分析模板，提取关键信息并将其附着到对应的虚拟节点上。在运行时阶段，渲染器通过这些关键信息执行“快捷路径”，从而提升性能。</p>
<p>编译优化的核心在于，<strong>区分动态节点与静态节点</strong>。Vue.js 3 会为动态节点打上补丁标志，即 patchFlag。同时，Vue.js 3 还提出了 <strong>Block</strong> 的概念，一个 Block 本质上也是一个虚拟节点，但与普通虚拟节点相比，会多出一个 dynamicChildren 数组。该数组用来收集所有动态子代节点，这利用了 createVNode 函数和createBlock 函数的层层嵌套调用的特点，即以“由内向外”的方式执行。再配合一个用来临时存储动态节点的节点栈，即可完成动态子代节点的收集。</p>
<p>由于 Block 会收集所有动态子代节点，所以对动态节点的比对操作是忽略 DOM 层级结构的。这会带来额外的问题，即 v-if、v-for 等结构化指令会影响 DOM 层级结构，使之不稳定。这会间接导致基基于 Block 树的比对算法失效。而解决方式很简单，只需要让带有 v-if、v-for 等指令的节点也作为 Block 角色即可。</p>
<p>除了 Block 树以及补丁标志之外，Vue.js 3 在编译优化方面还做了其他努力，具体如下。</p>
<ul>
<li>
<p>静态提升：能够减少更新时创建虚拟 DOM 带来的性能开销和内存占用。</p>
</li>
<li>
<p>预字符串化：在静态提升的基础上，对静态节点进行字符串化。这样做能够减少创建虚拟节点产生的性能开销以及内存占用。</p>
</li>
<li>
<p>缓存内联事件处理函数：避免造成不必要的组件更新。</p>
</li>
<li>
<p>v-once 指令：缓存全部或部分虚拟节点，能够避免组件更新时重新创建虚拟DOM 带来的性能开销，也可以避免无用的 Diff 操作。</p>
</li>
</ul>


                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="https://kcfuler.github.io"><img src="/img/favicon.png" />Kcfuler Blog</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2023/02/25/vuejs-component/" data-toggle="tooltip" data-placement="top" title="Vue的组件化">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2023/02/26/vuejs-ssr/" data-toggle="tooltip" data-placement="top" title="Vue的服务端渲染">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                



            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href="https://cloudmoonocus.github.io">cloudmoon</a></li>
                        
                        <li><a target="_blank" href="https://github.com/shinyina">shinyina</a></li>
                        
                        <li><a target="_blank" href="https://github.com/L-H-X">Juns</a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:2842961263@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat_qrcode.png">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/kcfuler">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Kcfuler Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Kcfuler Blog 2023
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
